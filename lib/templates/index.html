<!DOCTYPE html>
<head>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.0/TweenMax.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
</head>
<body>
  <div class='container'>
    {{#each this}}
      <div class='row'>
        <div class='col-md-12'>
          <span>{{ route.id }}</span>
          <span>[{{ route.request.method }}] {{ route.request.path }}</span>
          <div id='track' data-track='{{{ json track }}}'></div>
        </div>
        <div id='graph-{{ route.id }}' class='col-md-12 existsButHidden'></div>
      </div>
    {{/each}}
  </div>
</body>

<script type='text/javascript'>

  class TimelineRenderer {
    constructor() {
      this.loadedGraphs = [];
    }

    registerEvents() {
      const rows = document.getElementsByClassName('row');
      Array.from(rows).forEach((el) => {
        el.addEventListener('click', () => this.displayGraph(el));
      });
    }

    tween(t) {
      if (t.reversed()) {
        t.play()
      } else {
        t.reverse();
      }
    }

    displayGraph(el) {
      const trackParentEl = el.children[0];
      const graphEl = el.children[1];

      // toggle
      const isHidden = !!(Array.from(graphEl.classList).filter(x => x === 'existsButHidden' || x === 'hidden')[0]);
      if (isHidden) {
        // either create or show
        const isLoaded = this.loadedGraphs.map(x => x.id).indexOf(graphEl.id) > -1;
        if (isLoaded) {
          const t = this.loadedGraphs.filter(x => x.id === graphEl.id)[0].tween;
          this.tween(t);
          //graphEl.classList.remove('hidden');
          return Promise.resolve();
        }
        // create
        const trackEl = Array.from(trackParentEl.childNodes).filter(x => x.id === 'track')[0];
        const trackJson = JSON.parse(trackEl.getAttribute('data-track'));
        return this.makeGraph(graphEl, trackJson).then(() => {
          //graphEl.classList.remove('existsButHidden');

          const tween = TweenMax.to(graphEl, 0.2, { opacity:1, paused:true, reversed:true });
          this.loadedGraphs.push({
            id: graphEl.id,
            tween: tween
          });
          this.tween(t);
          return Promise.resolve();
        });
      }
      
      //graphEl.classList.add('hidden');
      const t = this.loadedGraphs.filter(x => x.id === graphEl.id)[0].tween;
      this.tween(t);
      return Promise.resolve();
    }

    makeGraph(el, track) {
      
      const drawChart = () => {
        const chart = new google.visualization.Timeline(el);
        const dataTable = new google.visualization.DataTable();
      
        dataTable.addColumn({ type: 'string', id: 'Item' });
        dataTable.addColumn({ type: 'string', id: 'dummy bar label' });
        dataTable.addColumn({ type: 'string', role: 'tooltip' });
        dataTable.addColumn({ type: 'number', id: 'Start' });
        dataTable.addColumn({ type: 'number', id: 'End' });

        const tooltip = (z) => JSON.stringify({
          start: z.timeElaspsed.start,
          end: z.timeElaspsed.end,
          elapsed: z.timeElaspsed.elapsed,
          value: z.response || z.error
        });

        dataTable.addRows(
          track.map(z => [z.message, null, tooltip(z), z.timeElaspsed.start, z.timeElaspsed.end])
        );

        const graphHeight = track.length > 5 ? `${5 * 70}` : `${track.length * 70}`
        chart.draw(dataTable, { tooltip: {isHtml: true}, height: graphHeight });
      }
      
      return new Promise((resolve) => { 
        google.charts.load('current', { 'packages':['timeline'] });
        google.charts.setOnLoadCallback(() => {
          drawChart();
          resolve();
        });
      });
    }
  };

  const renderer = new TimelineRenderer();
  renderer.registerEvents();

</script>

<style>
.row {
  margin-top: 10px;
  cursor: pointer;
}
.row .row {
  margin-top: 10px;
  margin-bottom: 0;
}
[class*="col-"] {
  padding-top: 15px;
  padding-bottom: 15px;
}
[class*="col-"]:nth-child(odd) {
  background-color: #eee;
  background-color: rgba(86,61,124,.15);
  border: 1px solid #ddd;
  border: 1px solid rgba(86,61,124,.2);
}
.existsButHidden {
  /*visibility: hidden;*/
  padding-top: 0px;
  padding-bottom: 0px;
  border: 0px;
  min-height: 0px;

  opacity: 0;
}
hr {
  margin-top: 40px;
  margin-bottom: 40px;
}
</style>